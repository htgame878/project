{% extends 'base.html' %}
{% load static %}

{% block extra_css %}

<style>
    :root {
        --primary-blue: #2563eb;
        --bg-slate: #f1f5f9;
        --white: #ffffff;
        --pill-radius: 50px;
        --card-radius: 20px;
    }

    body { background-color: var(--bg-slate);  direction: rtl;background-image: url("../images/13.svg") ;background-repeat: no-repeat; background-size: cover }

    .s2-wrapper { max-width: 1100px; margin: 30px auto; padding: 0 20px; }

    /* --- Header Section --- */
    .bundle-header {
        background: var(--white);
        padding: 25px;
        border-radius: var(--card-radius);
        margin-bottom: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }

    .bundle-info h1 { font-size: 1.4rem; color: var(--primary-blue); margin-bottom: 5px; }
    .bundle-info p { color: #64748b; font-size: 0.9rem; }

    /* --- Analysis Grid --- */
    .analysis-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }

    .card {
        background: var(--white);
        border-radius: var(--card-radius);
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        margin-bottom: 25px;
    }

    .card-title {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f1f5f9;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* --- Skill Table --- */
    .skill-table { width: 100%; border-collapse: collapse; }
    .skill-table th { text-align: right; padding: 12px; color: #64748b; font-size: 0.85rem; border-bottom: 1px solid #edf2f7; }
    .skill-table td { padding: 15px 12px; border-bottom: 1px solid #f7fafc; font-size: 0.95rem; }

    .badge-pill {
        padding: 4px 12px;
        border-radius: var(--pill-radius);
        font-size: 0.75rem;
        font-weight: 600;
    }

    .diff-easy { background: #dcfce7; color: #166534; }
    .diff-medium { background: #fef9c3; color: #854d0e; }
    .diff-hard { background: #fee2e2; color: #991b1b; }

    /* --- Macro Plan (Timeline) --- */
    .day-pill-container { display: flex; gap: 10px; margin-top: 15px; }
    .day-pill {
        flex: 1;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 15px;
        border-radius: 15px;
        text-align: center;
    }
    .day-pill span { display: block; font-weight: bold; color: var(--primary-blue); }

    /* --- Floating Action Button --- */
    .generate-btn {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: var(--primary-blue);
        color: white;
        padding: 15px 35px;
        border-radius: var(--pill-radius);
        font-weight: bold;
        text-decoration: none;
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.2s;
    }
    .generate-btn:hover { transform: scale(1.05); color: white; }

    @media (max-width: 900px) { .analysis-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
<div class="s2-wrapper">
    <header class="bundle-header">
        <div class="bundle-info">
            <h1>ØªØ­Ù„ÛŒÙ„ Ø¢Ø²Ù…ÙˆÙ†: {{ bundle.exam.title }}</h1>
            <p>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²: {{ bundle.student_name|default:"Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„..." }} | Ø§Ø³ØªØ§Ø¯: {{ bundle.teacher.get_full_name }}</p>
        </div>
        <div class="status-badge">
            <span class="badge-pill" style="background: #e0e7ff; color: #4338ca; padding: 8px 20px;">Stage 02: Analysis Done</span>
        </div>
    </header>

    <div class="analysis-grid">
        <div class="main-content">
            <div class="card">
                <div class="card-title">ğŸ” ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ù…ÙØ§Ù‡ÛŒÙ… (Item Analysis)</div>
                <table class="skill-table">
                    <thead>
                        <tr>
                            <th>Ù…ÙÙ‡ÙˆÙ… (Concept)</th>
                            <th>Ù…Ù‡Ø§Ø±Øª</th>
                            <th>Ø³Ø®ØªÛŒ</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        </tr>
                    </thead>
                    <tbody id="skill-body">
                        </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“… Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (Macro Plan)</div>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                    Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Û³ Ø±ÙˆØ² Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² ØªÙˆØ²ÛŒØ¹ Ø´Ø¯Ù‡ Ø§Ø³Øª:
                </p>
                <div class="day-pill-container" id="day-container">
                    </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <div class="card-title">ğŸ“ Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª</div>
                <div id="summary-text" style="font-size: 0.95rem; line-height: 1.8; color: #334155;">
                    Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...
                </div>
            </div>
            
            <div class="card" style="background: #f8fafc; border: 1px dashed #cbd5e1;">
                <div class="card-title" style="font-size: 0.9rem;">ğŸ“Š Ù…ØªØ§Ø¯ÛŒØªØ§ÛŒ ÙØ§ÛŒÙ„</div>
                <p style="font-size: 0.8rem; color: #64748b;">Ù‚Ø§Ù„Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡: {{ bundle.prompt_template.name }}</p>
                <p style="font-size: 0.8rem; color: #64748b;">ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: {{ bundle.created_at|date:"Y/m/d" }}</p>
            </div>
        </div>
    </div>
</div>

<a href="{{ SITE_URLS.exercise }}?bundle_id={{ bundle.id }}" class="generate-btn">
    <span>ØªÙˆÙ„ÛŒØ¯ ØªÙ…Ø±ÛŒÙ†Ø§Øª </span>
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
</a>

{# Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ÛŒ Stage 2 Ø§Ø² Ø³Ù…Øª Ø³Ø±ÙˆØ± #}
{{ bundle.result.json_data|json_script:"stage2-data" }}
    
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const data = JSON.parse(document.getElementById('stage2-data').textContent);
        
        // 1. Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§
        const skillBody = document.getElementById('skill-body');
        if (data.item_analysis_map) {
            Object.keys(data.item_analysis_map).forEach(key => {
                const item = data.item_analysis_map[key];
                const diffClass = item.difficulty === 'Easy' ? 'diff-easy' : (item.difficulty === 'Hard' ? 'diff-hard' : 'diff-medium');
                
                skillBody.innerHTML += `
                    <tr>
                        <td><strong>${item.concept_tested}</strong></td>
                        <td>${item.skill}</td>
                        <td><span class="badge-pill ${diffClass}">${item.difficulty}</span></td>
                        <td style="color: #64748b; font-size: 0.8rem;">${item.item_id || key}</td>
                    </tr>
                `;
            });
        }

        // 2. Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡ Û³ Ø±ÙˆØ²Ù‡
        const dayContainer = document.getElementById('day-container');
        if (data.plan_3_days) {
            data.plan_3_days.forEach(day => {
                dayContainer.innerHTML += `
                    <div class="day-pill">
                        <span style="font-size:0.8rem; color:#666">Ø±ÙˆØ² ${day.day_number}</span>
                        <span>${day.total_exercises_target} ØªÙ…Ø±ÛŒÙ†</span>
                        <small style="font-size:0.7rem; color:#94a3b8">${day.blocks.length} Ø¨Ù„Ø§Ú© Ø¢Ù…ÙˆØ²Ø´ÛŒ</small>
                    </div>
                `;
            });
        }

        // 3. Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ù…ØªÙ† Ú¯Ø²Ø§Ø±Ø´
        if (data.analysis_summary_fa) {
            document.getElementById('summary-text').innerText = data.analysis_summary_fa;
        }
    });
</script>
<script src="js/layout.js"></script>
{% endblock %}